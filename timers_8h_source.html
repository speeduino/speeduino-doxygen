<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.4"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Speeduino: speeduino/timers.h Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="speeduino_logo.png"/></td>
  <td id="projectalign">
   <div id="projectname">Speeduino
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.4 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_9dd927a2de2c3597e2b3a7dd174a4cd6.html">speeduino</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle"><div class="title">timers.h</div></div>
</div><!--header-->
<div class="contents">
<a href="timers_8h.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a id="l00001" name="l00001"></a><span class="lineno">    1</span> </div>
<div class="line"><a id="l00002" name="l00002"></a><span class="lineno">    2</span> </div>
<div class="line"><a id="l00003" name="l00003"></a><span class="lineno">    3</span><span class="comment">/*</span></div>
<div class="line"><a id="l00004" name="l00004"></a><span class="lineno">    4</span><span class="comment">NOTE - This file and it&#39;s associated functions need a CLEARER NAME</span></div>
<div class="line"><a id="l00005" name="l00005"></a><span class="lineno">    5</span><span class="comment"></span> </div>
<div class="line"><a id="l00006" name="l00006"></a><span class="lineno">    6</span><span class="comment">//Purpose</span></div>
<div class="line"><a id="l00007" name="l00007"></a><span class="lineno">    7</span><span class="comment">We&#39;re implementing a lower frequency interrupt loop to perform calculations that are needed less often, some of which depend on time having passed (delta/time) to be meaningful.</span></div>
<div class="line"><a id="l00008" name="l00008"></a><span class="lineno">    8</span><span class="comment"></span> </div>
<div class="line"><a id="l00009" name="l00009"></a><span class="lineno">    9</span><span class="comment"></span> </div>
<div class="line"><a id="l00010" name="l00010"></a><span class="lineno">   10</span><span class="comment">//Technical</span></div>
<div class="line"><a id="l00011" name="l00011"></a><span class="lineno">   11</span><span class="comment">Timer2 is only 8bit so we are setting the prescaler to 128 to get the most out of it. This means that the counter increments every 0.008ms and the overflow at 256 will be after 2.048ms</span></div>
<div class="line"><a id="l00012" name="l00012"></a><span class="lineno">   12</span><span class="comment">Max Period = (Prescale)*(1/Frequency)*(2^8)</span></div>
<div class="line"><a id="l00013" name="l00013"></a><span class="lineno">   13</span><span class="comment">(See arduinomega.blogspot.com.au/2011/05/timer2-and-overflow-interrupt-lets-get.html)</span></div>
<div class="line"><a id="l00014" name="l00014"></a><span class="lineno">   14</span><span class="comment"></span> </div>
<div class="line"><a id="l00015" name="l00015"></a><span class="lineno">   15</span><span class="comment">We&#39;re after a 1ms interval so we&#39;ll need 131 intervals to reach this ( 1ms / 0.008ms per tick = 125).</span></div>
<div class="line"><a id="l00016" name="l00016"></a><span class="lineno">   16</span><span class="comment">Hence we will preload the timer with 131 cycles to leave 125 until overflow (1ms).</span></div>
<div class="line"><a id="l00017" name="l00017"></a><span class="lineno">   17</span><span class="comment"></span> </div>
<div class="line"><a id="l00018" name="l00018"></a><span class="lineno">   18</span><span class="comment">*/</span></div>
<div class="line"><a id="l00019" name="l00019"></a><span class="lineno">   19</span><span class="preprocessor">#ifndef TIMERS_H</span></div>
<div class="line"><a id="l00020" name="l00020"></a><span class="lineno">   20</span><span class="preprocessor">#define TIMERS_H</span></div>
<div class="line"><a id="l00021" name="l00021"></a><span class="lineno">   21</span> </div>
<div class="line"><a id="l00022" name="l00022"></a><span class="lineno"><a class="line" href="timers_8h.html#a6a188777b3fa3f7f6e93124fee711846">   22</a></span><span class="preprocessor">#define SET_COMPARE(compare, value) compare = (COMPARE_TYPE)(value) </span><span class="comment">// It is important that we cast this to the actual overflow limit of the timer. The compare variables type can be bigger than the timer overflow.</span></div>
<div class="line"><a id="l00023" name="l00023"></a><span class="lineno">   23</span> </div>
<div class="line"><a id="l00024" name="l00024"></a><span class="lineno"><a class="line" href="timers_8h.html#ac7474e415bf6844551fc006986330d7c">   24</a></span><span class="keyword">volatile</span> <span class="keywordtype">bool</span> <a class="code hl_variable" href="timers_8h.html#ac7474e415bf6844551fc006986330d7c">tachoAlt</a> = <span class="keyword">false</span>;</div>
<div class="line"><a id="l00025" name="l00025"></a><span class="lineno"><a class="line" href="timers_8h.html#a875ca956caff6c349e6bac8de2248801">   25</a></span><span class="preprocessor">#define TACHO_PULSE_HIGH() *tach_pin_port |= (tach_pin_mask)</span></div>
<div class="line"><a id="l00026" name="l00026"></a><span class="lineno"><a class="line" href="timers_8h.html#ae960c1b872e48dfd99082e08af16cb07">   26</a></span><span class="preprocessor">#define TACHO_PULSE_LOW() *tach_pin_port &amp;= ~(tach_pin_mask)</span></div>
<div class="line"><a id="l00027" name="l00027"></a><span class="lineno"><a class="line" href="timers_8h.html#a8c08c47b167f96f6e2921d2846a575d9a33cf1d8ef1d06ee698a7fabf40eb3a7f">   27</a></span><span class="keyword">enum</span> <a class="code hl_enumeration" href="timers_8h.html#a8c08c47b167f96f6e2921d2846a575d9">TachoOutputStatus</a> {<a class="code hl_enumvalue" href="timers_8h.html#a8c08c47b167f96f6e2921d2846a575d9aa9724c8d010507da08eeeace81d14508">TACHO_INACTIVE</a>, <a class="code hl_enumvalue" href="timers_8h.html#a8c08c47b167f96f6e2921d2846a575d9a6564f2f3e15be06b670547bbcaaf0798">READY</a>, <a class="code hl_enumvalue" href="timers_8h.html#a8c08c47b167f96f6e2921d2846a575d9a33cf1d8ef1d06ee698a7fabf40eb3a7f">ACTIVE</a>}; <span class="comment">//The 3 statuses that the tacho output pulse can have. NOTE: Cannot just use &#39;INACTIVE&#39; as this is already defined within the Teensy Libs</span></div>
<div class="line"><a id="l00028" name="l00028"></a><span class="lineno">   28</span> </div>
<div class="line"><a id="l00029" name="l00029"></a><span class="lineno"><a class="line" href="timers_8h.html#a035c591acd8c728b3abdd011ef10a417">   29</a></span><span class="keyword">volatile</span> uint8_t <a class="code hl_variable" href="timers_8h.html#a035c591acd8c728b3abdd011ef10a417">tachoEndTime</a>; <span class="comment">//The time (in ms) that the tacho pulse needs to end at</span></div>
<div class="line"><a id="l00030" name="l00030"></a><span class="lineno"><a class="line" href="timers_8h.html#a1406c2c99a043c02419c75026a3cbd2d">   30</a></span><span class="keyword">volatile</span> <a class="code hl_enumeration" href="timers_8h.html#a8c08c47b167f96f6e2921d2846a575d9">TachoOutputStatus</a> <a class="code hl_variable" href="timers_8h.html#a1406c2c99a043c02419c75026a3cbd2d">tachoOutputFlag</a>;</div>
<div class="line"><a id="l00031" name="l00031"></a><span class="lineno">   31</span> </div>
<div class="line"><a id="l00032" name="l00032"></a><span class="lineno"><a class="line" href="timers_8h.html#abb944e77bfd49a4c2699d59a178a17ec">   32</a></span><span class="keyword">volatile</span> <span class="keywordtype">byte</span> <a class="code hl_variable" href="timers_8h.html#abb944e77bfd49a4c2699d59a178a17ec">loop33ms</a>;</div>
<div class="line"><a id="l00033" name="l00033"></a><span class="lineno"><a class="line" href="timers_8h.html#a0835d65288cd3fc5162a111762f598ea">   33</a></span><span class="keyword">volatile</span> <span class="keywordtype">byte</span> <a class="code hl_variable" href="timers_8h.html#a0835d65288cd3fc5162a111762f598ea">loop66ms</a>;</div>
<div class="line"><a id="l00034" name="l00034"></a><span class="lineno"><a class="line" href="timers_8h.html#abee157bd72540348338826e26f4ff526">   34</a></span><span class="keyword">volatile</span> <span class="keywordtype">byte</span> <a class="code hl_variable" href="timers_8h.html#abee157bd72540348338826e26f4ff526">loop100ms</a>;</div>
<div class="line"><a id="l00035" name="l00035"></a><span class="lineno"><a class="line" href="timers_8h.html#a98a956b21f0c584520ccc45c501b98d8">   35</a></span><span class="keyword">volatile</span> <span class="keywordtype">byte</span> <a class="code hl_variable" href="timers_8h.html#a98a956b21f0c584520ccc45c501b98d8">loop250ms</a>;</div>
<div class="line"><a id="l00036" name="l00036"></a><span class="lineno"><a class="line" href="timers_8h.html#a1321f3ca7623708598b3751940e9b343">   36</a></span><span class="keyword">volatile</span> <span class="keywordtype">int</span> <a class="code hl_variable" href="timers_8h.html#a1321f3ca7623708598b3751940e9b343">loopSec</a>;</div>
<div class="line"><a id="l00037" name="l00037"></a><span class="lineno">   37</span> </div>
<div class="line"><a id="l00038" name="l00038"></a><span class="lineno"><a class="line" href="timers_8h.html#ad9eeb05c018b7581903e860d16dd8df3">   38</a></span><span class="keyword">volatile</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code hl_variable" href="timers_8h.html#ad9eeb05c018b7581903e860d16dd8df3">dwellLimit_uS</a>;</div>
<div class="line"><a id="l00039" name="l00039"></a><span class="lineno"><a class="line" href="timers_8h.html#a62308a8f5625eee6429f4ffd7198071c">   39</a></span><span class="keyword">volatile</span> uint16_t <a class="code hl_variable" href="timers_8h.html#a62308a8f5625eee6429f4ffd7198071c">lastRPM_100ms</a>; <span class="comment">//Need to record this for rpmDOT calculation</span></div>
<div class="line"><a id="l00040" name="l00040"></a><span class="lineno"><a class="line" href="timers_8h.html#af63e608fdc59708993fd72d45a799c30">   40</a></span><span class="keyword">volatile</span> uint16_t <a class="code hl_variable" href="timers_8h.html#af63e608fdc59708993fd72d45a799c30">last250msLoopCount</a> = 1000; <span class="comment">//Set to effectively random number on startup. Just need this to be different to what mainLoopCount equals initially (Probably 0)</span></div>
<div class="line"><a id="l00041" name="l00041"></a><span class="lineno">   41</span> </div>
<div class="line"><a id="l00042" name="l00042"></a><span class="lineno">   42</span><span class="preprocessor">#if defined (CORE_TEENSY)</span></div>
<div class="line"><a id="l00043" name="l00043"></a><span class="lineno">   43</span>  IntervalTimer lowResTimer;</div>
<div class="line"><a id="l00044" name="l00044"></a><span class="lineno">   44</span>  <span class="keywordtype">void</span> <a class="code hl_function" href="timers_8ino.html#ae69bcc31c5bd2d5e2c7d008cb1ce7632">oneMSInterval</a>();</div>
<div class="line"><a id="l00045" name="l00045"></a><span class="lineno">   45</span><span class="preprocessor">#elif defined (ARDUINO_ARCH_STM32)</span></div>
<div class="line"><a id="l00046" name="l00046"></a><span class="lineno">   46</span>  <span class="keywordtype">void</span> <a class="code hl_function" href="timers_8ino.html#ae69bcc31c5bd2d5e2c7d008cb1ce7632">oneMSInterval</a>();</div>
<div class="line"><a id="l00047" name="l00047"></a><span class="lineno">   47</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l00048" name="l00048"></a><span class="lineno">   48</span><span class="keywordtype">void</span> <a class="code hl_function" href="timers_8h.html#a1810db7313ccf1b647a57d8c978c25c6">initialiseTimers</a>();</div>
<div class="line"><a id="l00049" name="l00049"></a><span class="lineno">   49</span> </div>
<div class="line"><a id="l00050" name="l00050"></a><span class="lineno">   50</span><span class="preprocessor">#endif </span><span class="comment">// TIMERS_H</span></div>
<div class="ttc" id="atimers_8h_html_a035c591acd8c728b3abdd011ef10a417"><div class="ttname"><a href="timers_8h.html#a035c591acd8c728b3abdd011ef10a417">tachoEndTime</a></div><div class="ttdeci">volatile uint8_t tachoEndTime</div><div class="ttdef"><b>Definition:</b> timers.h:29</div></div>
<div class="ttc" id="atimers_8h_html_a0835d65288cd3fc5162a111762f598ea"><div class="ttname"><a href="timers_8h.html#a0835d65288cd3fc5162a111762f598ea">loop66ms</a></div><div class="ttdeci">volatile byte loop66ms</div><div class="ttdef"><b>Definition:</b> timers.h:33</div></div>
<div class="ttc" id="atimers_8h_html_a1321f3ca7623708598b3751940e9b343"><div class="ttname"><a href="timers_8h.html#a1321f3ca7623708598b3751940e9b343">loopSec</a></div><div class="ttdeci">volatile int loopSec</div><div class="ttdef"><b>Definition:</b> timers.h:36</div></div>
<div class="ttc" id="atimers_8h_html_a1406c2c99a043c02419c75026a3cbd2d"><div class="ttname"><a href="timers_8h.html#a1406c2c99a043c02419c75026a3cbd2d">tachoOutputFlag</a></div><div class="ttdeci">volatile TachoOutputStatus tachoOutputFlag</div><div class="ttdef"><b>Definition:</b> timers.h:30</div></div>
<div class="ttc" id="atimers_8h_html_a1810db7313ccf1b647a57d8c978c25c6"><div class="ttname"><a href="timers_8h.html#a1810db7313ccf1b647a57d8c978c25c6">initialiseTimers</a></div><div class="ttdeci">void initialiseTimers()</div><div class="ttdef"><b>Definition:</b> timers.ino:27</div></div>
<div class="ttc" id="atimers_8h_html_a62308a8f5625eee6429f4ffd7198071c"><div class="ttname"><a href="timers_8h.html#a62308a8f5625eee6429f4ffd7198071c">lastRPM_100ms</a></div><div class="ttdeci">volatile uint16_t lastRPM_100ms</div><div class="ttdef"><b>Definition:</b> timers.h:39</div></div>
<div class="ttc" id="atimers_8h_html_a8c08c47b167f96f6e2921d2846a575d9"><div class="ttname"><a href="timers_8h.html#a8c08c47b167f96f6e2921d2846a575d9">TachoOutputStatus</a></div><div class="ttdeci">TachoOutputStatus</div><div class="ttdef"><b>Definition:</b> timers.h:27</div></div>
<div class="ttc" id="atimers_8h_html_a8c08c47b167f96f6e2921d2846a575d9a33cf1d8ef1d06ee698a7fabf40eb3a7f"><div class="ttname"><a href="timers_8h.html#a8c08c47b167f96f6e2921d2846a575d9a33cf1d8ef1d06ee698a7fabf40eb3a7f">ACTIVE</a></div><div class="ttdeci">@ ACTIVE</div><div class="ttdef"><b>Definition:</b> timers.h:27</div></div>
<div class="ttc" id="atimers_8h_html_a8c08c47b167f96f6e2921d2846a575d9a6564f2f3e15be06b670547bbcaaf0798"><div class="ttname"><a href="timers_8h.html#a8c08c47b167f96f6e2921d2846a575d9a6564f2f3e15be06b670547bbcaaf0798">READY</a></div><div class="ttdeci">@ READY</div><div class="ttdef"><b>Definition:</b> timers.h:27</div></div>
<div class="ttc" id="atimers_8h_html_a8c08c47b167f96f6e2921d2846a575d9aa9724c8d010507da08eeeace81d14508"><div class="ttname"><a href="timers_8h.html#a8c08c47b167f96f6e2921d2846a575d9aa9724c8d010507da08eeeace81d14508">TACHO_INACTIVE</a></div><div class="ttdeci">@ TACHO_INACTIVE</div><div class="ttdef"><b>Definition:</b> timers.h:27</div></div>
<div class="ttc" id="atimers_8h_html_a98a956b21f0c584520ccc45c501b98d8"><div class="ttname"><a href="timers_8h.html#a98a956b21f0c584520ccc45c501b98d8">loop250ms</a></div><div class="ttdeci">volatile byte loop250ms</div><div class="ttdef"><b>Definition:</b> timers.h:35</div></div>
<div class="ttc" id="atimers_8h_html_abb944e77bfd49a4c2699d59a178a17ec"><div class="ttname"><a href="timers_8h.html#abb944e77bfd49a4c2699d59a178a17ec">loop33ms</a></div><div class="ttdeci">volatile byte loop33ms</div><div class="ttdef"><b>Definition:</b> timers.h:32</div></div>
<div class="ttc" id="atimers_8h_html_abee157bd72540348338826e26f4ff526"><div class="ttname"><a href="timers_8h.html#abee157bd72540348338826e26f4ff526">loop100ms</a></div><div class="ttdeci">volatile byte loop100ms</div><div class="ttdef"><b>Definition:</b> timers.h:34</div></div>
<div class="ttc" id="atimers_8h_html_ac7474e415bf6844551fc006986330d7c"><div class="ttname"><a href="timers_8h.html#ac7474e415bf6844551fc006986330d7c">tachoAlt</a></div><div class="ttdeci">volatile bool tachoAlt</div><div class="ttdef"><b>Definition:</b> timers.h:24</div></div>
<div class="ttc" id="atimers_8h_html_ad9eeb05c018b7581903e860d16dd8df3"><div class="ttname"><a href="timers_8h.html#ad9eeb05c018b7581903e860d16dd8df3">dwellLimit_uS</a></div><div class="ttdeci">volatile unsigned int dwellLimit_uS</div><div class="ttdef"><b>Definition:</b> timers.h:38</div></div>
<div class="ttc" id="atimers_8h_html_af63e608fdc59708993fd72d45a799c30"><div class="ttname"><a href="timers_8h.html#af63e608fdc59708993fd72d45a799c30">last250msLoopCount</a></div><div class="ttdeci">volatile uint16_t last250msLoopCount</div><div class="ttdef"><b>Definition:</b> timers.h:40</div></div>
<div class="ttc" id="atimers_8ino_html_ae69bcc31c5bd2d5e2c7d008cb1ce7632"><div class="ttname"><a href="timers_8ino.html#ae69bcc31c5bd2d5e2c7d008cb1ce7632">oneMSInterval</a></div><div class="ttdeci">void oneMSInterval()</div><div class="ttdef"><b>Definition:</b> timers.ino:44</div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Wed Aug 31 2022 06:19:35 for Speeduino by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.4
</small></address>
</body>
</html>
